@echo off
chcp 65001 > nul
echo ====================================================
echo    Обновление сайта через GitHub для Dokploy
echo ====================================================
echo.

cd %~dp0

echo [1/3] Добавление измененных файлов...
git add .
if %errorlevel% neq 0 (
    echo Ошибка при добавлении файлов в git.
    pause
    exit /b %errorlevel%
)

echo.
echo [2/3] Создание сохранения (коммита)...
git commit -m "Автоматическое обновление сайта"
:: Не проверяем ошибку тут, так как может просто не быть изменений

echo.
echo [3/3] Отправка изменений на сервер (GitHub)...
echo.
git push -u origin main
if %errorlevel% neq 0 (
    echo Ошибка при отправке на GitHub!
    pause
    exit /b %errorlevel%
)

echo.
echo ====================================================
echo    Готово! Изменения успешно отправлены на GitHub!
echo    Dokploy сейчас автоматически начнет сборку новой 
echo    версии сайта. Это займет около 2-3 минут.
echo ====================================================

echo.
echo Начинаем очистку старых сборок на сервере (освобождение места)...
echo (Потребуется ввести пароль от сервера root@155.212.216.227)
ssh root@155.212.216.227 "docker system prune -a --volumes -f"

echo.
echo Очистка завершена!
echo ====================================================

pause
